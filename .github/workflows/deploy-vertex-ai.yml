name: Deploy to Vertex AI

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    branches:
      - main
    paths:
      - 'deploy/vertex-ai/**'
      - 'src/**'

env:
  GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
  GOOGLE_REGION: ${{ secrets.GOOGLE_REGION || 'us-central1' }}

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'dev'
    environment:
      name: dev
      url: https://dev-rag7-agent-api-${{ secrets.GOOGLE_PROJECT_ID }}.uc.r.appspot.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Vertex AI Agent
        run: |
          chmod +x deploy/vertex-ai/deploy.sh
          ./deploy/vertex-ai/deploy.sh dev

      - name: Run Health Check
        run: |
          sleep 30
          ENDPOINT=$(gcloud ai endpoints list --region=${{ env.GOOGLE_REGION }} \
            --filter="displayName:rag7-agent-dev" --format="value(name)")
          
          if [ -z "$ENDPOINT" ]; then
            echo "Error: Endpoint not found"
            exit 1
          fi
          
          echo "Endpoint deployed successfully: $ENDPOINT"

      - name: Validation Tests
        run: |
          pip install -q httpx pytest
          pytest tests/e2e/test_smoke.py -v --endpoint-url=${{ env.GOOGLE_REGION }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: []
    if: github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging-rag7-agent-api-${{ secrets.GOOGLE_PROJECT_ID }}.uc.r.appspot.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run Integration Tests
        run: |
          pip install -q -r requirements-dev.txt
          pytest tests/integration/ -v

      - name: Deploy Vertex AI Agent
        run: |
          chmod +x deploy/vertex-ai/deploy.sh
          ./deploy/vertex-ai/deploy.sh staging

      - name: Run Health Check
        run: |
          sleep 30
          ENDPOINT=$(gcloud ai endpoints list --region=${{ env.GOOGLE_REGION }} \
            --filter="displayName:rag7-agent-staging" --format="value(name)")
          
          if [ -z "$ENDPOINT" ]; then
            echo "Error: Endpoint not found"
            exit 1
          fi

      - name: Smoke Tests
        run: |
          pytest tests/e2e/test_smoke.py -v --endpoint-url=${{ env.GOOGLE_REGION }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: []
    if: github.event.inputs.environment == 'prod'
    environment:
      name: production
      url: https://rag7-agent-api-${{ secrets.GOOGLE_PROJECT_ID }}.uc.r.appspot.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Vertex AI Agent
        run: |
          chmod +x deploy/vertex-ai/deploy.sh
          ./deploy/vertex-ai/deploy.sh prod

      - name: Run Health Check
        run: |
          sleep 30
          ENDPOINT=$(gcloud ai endpoints list --region=${{ env.GOOGLE_REGION }} \
            --filter="displayName:rag7-agent-prod" --format="value(name)")
          
          if [ -z "$ENDPOINT" ]; then
            echo "Error: Endpoint not found"
            exit 1
          fi

      - name: Production Validation
        run: |
          pytest tests/e2e/test_smoke.py -v --endpoint-url=${{ env.GOOGLE_REGION }}

      - name: Monitor Deployment
        run: |
          echo "Monitoring deployment for 5 minutes..."
          for i in {1..10}; do
            sleep 30
            ERROR_RATE=$(gcloud monitoring time-series list \
              --filter="metric.type=aiplatform.googleapis.com/prediction/error_count" \
              --format="value(point.value.doubleValue)" || echo "0")
            
            if (( $(echo "$ERROR_RATE > 5" | bc -l) )); then
              echo "Error rate too high: $ERROR_RATE%"
              exit 1
            fi
            echo "Check $i/10: Error rate: $ERROR_RATE%"
          done

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          ./deploy/vertex-ai/rollback.sh prod
